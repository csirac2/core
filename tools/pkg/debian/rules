#!/usr/bin/make -f
# Sample debian/rules that uses debhelper.
# GNU copyright 1997 to 1999 by Joey Hess.

include /usr/share/dpatch/dpatch.make

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# not www-data.  remember to sync with postinst.
WIKI_OWNER=www-data

configure: configure-stamp
configure-stamp:
	dh_testdir
	touch configure-stamp

build: patch build-stamp

build-stamp: configure-stamp
	dh_testdir
	touch build-stamp

clean: clean-patched unpatch
clean-patched:
	dh_testdir
	dh_testroot
	find . -name '*~' -print0 | xargs -0 rm -f
	rm -f build-stamp configure-stamp
	debconf-updatepo
	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs
	
	# handle the MANIFEST-based debian/*.install files
	# generated by autobuild-deb.sh
	dh_install

	# packaging changes outside the MANIFEST files
	chmod 755 debian/foswiki-core/var/lib/foswiki/bin/*
	mv debian/foswiki-core/var/lib/foswiki/bin/configure debian/foswiki-configure-cgi/var/lib/foswiki/bin/
	cp debian/setlib.cfg debian/foswiki-core/var/lib/foswiki/bin/setlib.cfg
	chmod 644 debian/foswiki-core/var/lib/foswiki/bin/setlib.cfg
	cp debian/Foswiki.spec debian/foswiki-core/var/lib/foswiki/lib/Foswiki.spec
	chmod 644 debian/foswiki-core/var/lib/foswiki/lib/Foswiki.spec

	perl -piOLD -e 's{#! perl}{#!/usr/bin/perl}g;' debian/foswiki-core/var/lib/foswiki/tools/rewriteshbang.pl
	perl -piOLD -e 's{#!perl}{#!/usr/bin/perl}g;' debian/foswiki-core/var/lib/foswiki/tools/upgrade_emails.pl
	rm debian/foswiki-core/var/lib/foswiki/tools/*OLD

	find debian/foswiki-core/var/lib/foswiki/data -type f -name '*,v' | \
	  xargs -n1 perl -pi -e 's/^(\s)nobody:/\1$(WIKI_OWNER):/ unless $$done; $$done=1 if /^\n$$/;'

	# separate packages for the default data in each major Web, so
	# admins can decide which are package managed vs user editable
	# Anything left over is put in the example data packaged tarball
	#
	mv debian/foswiki-core/var/lib/foswiki/data/System debian/foswiki-system-web-data/var/lib/foswiki/data/
	mv debian/foswiki-core/var/lib/foswiki/data/_default debian/foswiki-default-web-data/var/lib/foswiki/data/
	mv debian/foswiki-core/var/lib/foswiki/data/_empty debian/foswiki-empty-web-data/var/lib/foswiki/data/

	#create mailnotify timestamps
	date +%s > debian/foswiki-system-web-data/var/lib/foswiki/data/System/.mailnotify
	date +%s > debian/foswiki-core/var/lib/foswiki/data/Main/.mailnotify
	date +%s > debian/foswiki-core/var/lib/foswiki/data/Sandbox/.mailnotify
	tar -cf - -C debian/foswiki-core var/lib/foswiki/data \
		| tardy -User_NAme=$(WIKI_OWNER) -Group_NAme=www-data \
		| gzip -c -9 > debian/foswiki-example-data/usr/share/foswiki/foswiki-data.tar.gz
	rm -rf debian/foswiki-core/var/lib/foswiki/data

#do the same with pub - it should also only be replaced if there is none there already
# and it needs to be owned by $(WIKI_OWNER)
	find debian/foswiki-core/var/lib/foswiki/pub -type f -name '*,v' | \
	  xargs -n1 perl -pi -e 's/^(\s)nobody:/\1$(WIKI_OWNER):/ unless $$done; $$done=1 if /^\n$$/;'
	mv debian/foswiki-core/var/lib/foswiki/pub/System debian/foswiki-system-web-data/var/lib/foswiki/pub/
	tar -cf - -C debian/foswiki-core var/lib/foswiki/pub \
		| tardy -User_NAme=$(WIKI_OWNER) -Group_NAme=www-data \
		| gzip -c -9 > debian/foswiki-example-data/usr/share/foswiki/foswiki-pub.tar.gz
	rm -rf debian/foswiki-core/var/lib/foswiki/pub


	# libfoswiki-cpan-perl, moved from foswiki-core to optional package
	mkdir -p debian/libfoswiki-cpan-perl/var/lib/foswiki/lib
	mv debian/foswiki-core/var/lib/foswiki/lib/CPAN debian/libfoswiki-cpan-perl/var/lib/foswiki/lib/

	cp debian/apache.conf debian/foswiki-apache2/etc/foswiki/
	ln -s /etc/foswiki/apache.conf debian/foswiki-apache2/etc/apache2/sites-available/foswiki.conf
	ln -s ../sites-available/foswiki.conf debian/foswiki-apache2/etc/apache2/sites-enabled/foswiki.conf

	chown -R www-data:www-data debian/*/var/lib/foswiki/working
	chmod -R 1770 debian/*/var/lib/foswiki/working
	for d in var/lib/foswiki/data var/lib/foswiki/data/Main	\
	    var/lib/foswiki/data/Trash var/lib/foswiki/data/Sandbox \
	    var/lib/foswiki/pub var/log/foswiki; do \
		chown www-data:www-data debian/*/$$d ; \
		chmod 3770 debian/*/$$d ; \
	done

# Build architecture-independent files here.
binary-indep: build install
	dh_testdir
	dh_testroot
	dh_installdebconf
	dh_installdocs -Xlicense.txt
	dh_installexamples
	dh_installmenu
#	dh_installlogrotate
#	dh_installemacsen
#	dh_installpam
#	dh_installmime
#	dh_installinit
	dh_installcron
	dh_installman
	dh_installinfo
#	dh_undocumented
	dh_installchangelogs
	dh_link
	dh_strip
	dh_compress
	dh_fixperms --exclude /var/lib/foswiki/data \
		--exclude /var/lib/foswiki/pub \
		--exclude /var/log/foswiki \
		--exclude /var/lib/foswiki/working
#	dh_makeshlibs
	dh_installdeb
	dh_perl
#	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

# Build architecture-dependent files here.
binary-arch: build install
# We have nothing to do by default.

# maintainer targets
#checkpo:
#	for i in po/*.po; do \
#		echo \"Checking: $$i\"; \
#		msgmerge -U $$i po/templates.pot; \
#		msgfmt -o /dev/null -c --statistics $$i; \
#	done

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure
