#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2012-1004.dpatch by  <sven@quad.home.org.au>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: No description.

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' foswiki-1.1.4~/lib/Foswiki/UI/Register.pm foswiki-1.1.4/lib/Foswiki/UI/Register.pm
--- foswiki-1.1.4~/lib/Foswiki/UI/Register.pm	2011-12-21 02:33:22.000000000 +1100
+++ foswiki-1.1.4/lib/Foswiki/UI/Register.pm	2012-02-09 11:12:25.000000000 +1100
@@ -1563,6 +1563,10 @@
             # It is the responsibility of the implementation code to untaint
             # these data before they are used in dangerous ways.
             # DO NOT UNTAINT THESE DATA HERE!
+            unless ( $name =~ m/^(?:wikiname|name|loginname|username|password|confirm)$/i ) {
+                $value =~ s/([<>%'"])/'&#'.ord($1).';'/ge;
+            }
+
             $data->{$name} = $value;
             push(
                 @{ $data->{form} },
