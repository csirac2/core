#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2012-1004.dpatch by  <sven@quad.home.org.au>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: No description.

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' fosiki~/un/Foswiki-1.1.3/lib/Foswiki/UI/Register.pm fosiki/un/Foswiki-1.1.3/lib/Foswiki/UI/Register.pm
--- fosiki~/un/Foswiki-1.1.3/lib/Foswiki/UI/Register.pm	2011-04-17 06:29:33.000000000 +1000
+++ fosiki/un/Foswiki-1.1.3/lib/Foswiki/UI/Register.pm	2012-02-09 11:12:25.000000000 +1100
@@ -875,6 +875,7 @@
             $session->{user} =
               $session->{users}->getCanonicalUserID(
                 $Foswiki::cfg{Register}{RegistrationAgentWikiName} );
+            $regoAgent = $session->{user};
 
             # SECURITY ISSUE:
             # When upgrading an existing Wiki, the RegistrationUser is
@@ -895,17 +896,28 @@
             }
         }
 
+        my @addedTo;
+
         if ( ($enableAddToGroup) and ( $data->{AddToGroups} ) ) {
             foreach my $groupName ( split( /,/, $data->{AddToGroups} ) ) {
                 $session->{user} = $regoAgent;
                 try {
                     $users->addUserToGroup( $cUID, $groupName );
+                    push @addedTo, $groupName;
+                    print STDERR "Fell through adding $groupName\n";
+                }
+                catch Error::Simple with {
+                    my $e = shift;
+                    $session->logger->log( 'warning',
+                        "Registration: Failure adding $cUID to $groupName" );
                 }
                 finally {
                     $session->{user} = $safe;
                 };
             }
         }
+
+        $data->{AddToGroups} = join( ',', @addedTo );
     }
     catch Error::Simple with {
         my $e = shift;
@@ -1219,6 +1231,10 @@
     foreach my $fd ( @{ $data->{form} } ) {
         my $name  = $fd->{name};
         my $value = $fd->{value};
+
+        # Override value - Group list might have changed
+        $value = $data->{AddToGroups} if ( $name eq 'AddToGroups' );
+
         if ( ( $name eq 'Password' ) && ($hidePassword) ) {
             $value = '*******';
         }
@@ -1530,7 +1546,7 @@
     # get all parameters from the form
     my $data = {};
     foreach my $key ( $query->param() ) {
-        if ( $key =~ /^(Twk([0-9])(.*))/
+        if ( $key =~ /^((?:Twk|Fwk)([0-9])(.*))/
             and ( defined( $query->param($key) ) ) )
         {
             my @values   = $query->param($key);
@@ -1547,6 +1563,10 @@
             # It is the responsibility of the implementation code to untaint
             # these data before they are used in dangerous ways.
             # DO NOT UNTAINT THESE DATA HERE!
+            unless ( $name =~ m/^(?:wikiname|name|loginname|username|password|confirm)$/i ) {
+                $value =~ s/([<>%'"])/'&#'.ord($1).';'/ge;
+            }
+
             $data->{$name} = $value;
             push(
                 @{ $data->{form} },
